name: CI
on:
  push:
    branches-ignore:
      - 'update-dependencies'
      - 'dependabot/*'
  pull_request:
env:
  FORCE_COLOR: "1"
  PY_COLORS: "1"
  MYPY_FORCE_TERMINAL_WIDTH: "180"

jobs:
  tests:
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    timeout-minutes: 45
    # continue-on-error: "${{ matrix.experimental == true }}"
    strategy:
      fail-fast: false
      matrix:
        include:
          ### PyQt 5.15 (Python 3.11)
          - testenv: py311-pyqt515
            os: ubuntu-20.04
            python: "3.11"
            args: tests/end2end/features/test_hints_bdd.py
          ### Windows: PyQt 5.15 (Python 3.9 to match PyInstaller env)
          - testenv: py39-pyqt515
            os: windows-2019
            python: "3.9"
            args: tests/end2end/features/test_hints_bdd.py
    runs-on: "${{ matrix.os }}"
    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false
      - uses: actions/cache@v3
        with:
          path: |
            .mypy_cache
            .tox
            ~/.cache/pip
          key: "${{ matrix.testenv }}-${{ matrix.os }}-${{ matrix.python }}-${{ hashFiles('misc/requirements/requirements-*.txt') }}-${{ hashFiles('requirements.txt') }}"
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "${{ matrix.python }}"
      - name: Set up problem matchers
        run: "python scripts/dev/ci/problemmatchers.py ${{ matrix.testenv }} ${{ runner.temp }}"
      - name: Install apt dependencies
        run: |
            sudo apt-get update
            sudo apt-get install --no-install-recommends libyaml-dev libegl1-mesa libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-shape0
        if: "startsWith(matrix.os, 'ubuntu-')"
      - name: Install dependencies
        run: |
            python -m pip install -U pip
            python -m pip install -U -r misc/requirements/requirements-tox.txt
      - name: "Run ${{ matrix.testenv }}"
        run: "dbus-run-session -- tox -e ${{ matrix.testenv }} -- ${{ matrix.args }}"
        if: "startsWith(matrix.os, 'ubuntu-')"
      - name: "Run ${{ matrix.testenv }} without DBus"
        run: "tox -e ${{ matrix.testenv }} -- ${{ matrix.args }}"
        if: "!startsWith(matrix.os, 'ubuntu-')"
      - name: Analyze backtraces
        run: "bash scripts/dev/ci/backtrace.sh ${{ matrix.testenv }}"
        if: "failure()"
